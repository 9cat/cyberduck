<?xml version="1.0" encoding="UTF-8"?>
<!--
 *	Simple Ant (http://jakarta.apache.org/ant) build script for Cyberduck
 *
 *	$Revision$
 *	$Date$
 *
 *  Copyright (c) 2005-2012 David Kocher. All rights reserved.
 *  http://cyberduck.io/
 *
 *	This program is free software; you can redistribute it and/or modify
 *	it under the terms of the GNU General Public License as published by
 *	the Free Software Foundation; either version 2 of the License, or
 *	(at your option) any later version.
 *
 *	This program is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *
 *	Bug fixes, suggestions and comments should be sent to:
 *	dkocher@cyberduck.io
 -->
<project name="Cyberduck for Linux" basedir=".">

    <import file="build-windows.xml"/>

    <property name="ikvm.home" value="${home}/ikvm-7.2.4630.5"/>

    <target name="build">
        <echo message="Version=${version}"/>
        <echo message="ShortVersion=${shortversion}"/>
        <echo message="Configuration=${configuration}"/>
        <echo message="Platform=${architecture}"/>

        <exec executable="xbuild" dir="${home}">
            <arg value="/target:build"/>
            <!--<arg value="/verbosity:minimal"/>-->
            <arg value="/property:Version=${version}"/>
            <arg value="/property:ShortVersion=${shortversion}"/>
            <arg value="/property:Configuration=${configuration}"/>
            <arg value="/property:Platform=${architecture}"/>
            <arg value="source/ch/cyberduck/Cyberduck.csproj"/>
        </exec>
    </target>

    <target name="dll" depends="version, archive">
        <fileset id="jars" dir=".">
            <include name="build/core.jar"/>
            <include name="build/ui.jar"/>
            <include name="lib/*.jar"/>
            <exclude name="lib/jna-*.jar"/>
            <exclude name="lib/asm-*.jar"/>
            <exclude name="lib/cglib-*.jar"/>
            <exclude name="lib/dns_sd.jar"/>
            <exclude name="lib/rococoa-*.jar"/>
        </fileset>
        <pathconvert property="jars" refid="jars" pathsep=" ">
            <mapper type="regexp" from="^(.*)$" to="{ \1 }"/>
        </pathconvert>
        <echo message="Building ${build}/core.dll"/>
        <exec executable="${ikvm.home}/bin/ikvmc.exe" dir="${home}">
            <arg value="-out:${build}/core.dll"/>
            <arg value="-assembly:${core}"/>
            <arg value="-version:${version}"/>
            <arg value="-platform:x86"/>
            <arg value="-target:library"/>
            <arg value="-sharedclassloader"/>
            <arg line="${jars}"/>
        </exec>
    </target>

    <target name="release" depends="clean, package-release">
        <antcall target="confirm"/>
        <scp file="${setup.file}"
             todir="dkocher@update.cyberduck.io:./update.cyberduck.io/linux"
             keyfile="${user.home}/.ssh/update.cyberduck.io-rsa"
             passphrase="">
        </scp>
    </target>

    <target name="nightly" depends="clean, package-nightly">
        <scp file="${setup.file}"
             todir="dkocher@update.cyberduck.io:./update.cyberduck.io/linux/nightly"
             keyfile="${user.home}/.ssh/update.cyberduck.io-rsa"
             passphrase="">
        </scp>
    </target>

    <target name="beta" depends="clean, package-beta">
        <scp file="${setup.file}"
             todir="dkocher@update.cyberduck.io:./update.cyberduck.io/linux/beta"
             keyfile="${user.home}/.ssh/update.cyberduck.io-rsa"
             passphrase="">
        </scp>
    </target>

    <target name="package-release" depends="version">
        <property name="setup.file"
                  location="${build}/${app.name}-${cyberduck.version.major}.${cyberduck.version.minor}.exe"/>
        <antcall target="package"/>
    </target>

    <target name="package-beta" depends="version">
        <property name="setup.file"
                  location="${build}/${app.name}-${cyberduck.version.major}.${cyberduck.version.minor}.${svn.revision}.exe"/>
        <antcall target="package"/>
    </target>

    <target name="package-nightly" depends="version">
        <property name="setup.file"
                  location="${build}/${app.name}-${cyberduck.version.major}.${cyberduck.version.minor}.${svn.revision}.exe"/>
        <antcall target="package"/>
    </target>

    <target name="package" depends="dll, build"/>
</project>
